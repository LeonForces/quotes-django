# Quotes Django

Небольшое Django‑приложение, которое показывает случайную цитату из фильма/книги с учётом «веса», позволяет добавлять новые цитаты, ставить лайки/дизлайки, считать просмотры и выводить топ‑10.

## Возможности

- Случайная цитата с весами (чем больше вес, тем чаще появляется)
- Счётчик просмотров
- Лайки/дизлайки с защитой от накрутки в рамках сессии и возможностью переключать голос (лайк ↔ дизлайк)
- После голосования показывается новая случайная цитата, отличная от текущей (предыдущей цитате просмотр не добавляется)
- Добавление новых цитат через форму
- Запрет дублей (по тексту и источнику, регистронезависимо)
- Не более 3 цитат от одного источника (регистронезависимо)
- Единая страница топ‑10 с выбором сортировки: по лайкам, по просмотрам или по дизлайкам
- Простая страница дашборда с агрегатом (суммарные просмотры/лайки/дизлайки, мини‑топы)

## Требования

- Python 3.11+ (проект разрабатывался на Python 3.13)
- Django 5.x
- SQLite (по умолчанию)

## Быстрый старт (локально)

1) Клонируйте/откройте проект и создайте виртуальное окружение

```bash
python3 -m venv .venv
```

2) Активируйте окружение

```bash
source .venv/bin/activate
```

3) Установите зависимости (минимум Django)

```bash
pip install "Django>=5.2"
```

4) Примените миграции

```bash
python manage.py migrate
```

5) (Опционально) создайте суперпользователя для админки

```bash
python manage.py createsuperuser
```

6) Запустите сервер разработки

```bash
python manage.py runserver
```

Откройте в браузере http://127.0.0.1:8000/

## Основные URL

- Главная (случайная цитата): `/`
- Добавить цитату: `/submit/`
- Топ‑10 (единая страница): `/popular/?sort=likes|views|dislikes`
  - Старые адреса продолжают работать и делают редирект:
    - `/popular/views/` -> `/popular/?sort=views`
    - `/popular/dislikes/` -> `/popular/?sort=dislikes`
- Голосование (POST): `/vote/<id>/<action>/` где `action` — `like` или `dislike`

Примечание: при голосовании мы редиректим обратно на конкретную цитату с параметром `no_view=1`, чтобы не увеличивать счётчик просмотров на лайк/дизлайк.

## Бизнес‑правила

- У одного источника не может быть больше 3 цитат (проверяется валидацией модели)
- Дубликаты (текст+источник) запрещены (регистронезависимо, через уникальный индекс)
- Вес цитаты — положительное целое число (минимум 1)
- Голосование защищено в рамках сессии: повторного одинакового голоса не происходит; можно сменить голос (лайк ↔ дизлайк) — счётчики пересчитываются корректно
- После голосования пользователь видит новую случайную цитату (отличную от предыдущей). Просмотр не добавляется прежней цитате; новая цитата получает +1 просмотр как обычный показ

## Структура проекта

- Приложение: `quotes/` (модели, формы, вьюхи, шаблоны)
- Шаблоны: `templates/` (общий `base.html`) и `quotes/templates/quotes/` (страницы приложения)
- Настройки: `config/settings.py`
- URL‑маршруты: `config/urls.py`, `quotes/urls.py`
- БД: `db.sqlite3` (по умолчанию)

## Админка

- Доступна по адресу `/admin/`
- После `createsuperuser` войдите и управляйте цитатами из интерфейса администратора

## Продакшен‑заметки

- Установите `DEBUG = False` и уникальный `SECRET_KEY` перед продакшеном
- Настройте статику: `STATIC_ROOT` и выполните сборку

```bash
python manage.py collectstatic
```

- Настройте постоянную БД (PostgreSQL/MySQL), если нужно
- Ограничьте `ALLOWED_HOSTS` до желаемых доменов

## Фронтенд и статические файлы

- Стили: `static/css/styles.css` — светлая тема (жёлтый акцент `#FFCC00`)
- JavaScript: `static/js/app.js` — автоскрытие сообщений и защита от двойной отправки голосов
- TypeScript: `static/ts/app.ts` — типобезопасная версия логики из app.js

## Тестирование

В проекте используются pytest и pytest-django.

Установка зависимостей (в активированном виртуальном окружении):
```bash
pip install pytest pytest-django
```

Запуск всех тестов:
```bash
pytest
```

Полезные опции pytest:
- Показ расширенного отчёта: `pytest -ra`
- Запуск конкретного файла: `pytest quotes/tests/test_views_vote.py`
- Запуск с выводом захваченного вывода: `pytest -s`

Конфигурация находится в файле `pytest.ini`:
- DJANGO_SETTINGS_MODULE = `config.settings`
- Шаблоны имён тестов: `tests.py`, `test_*.py`, `*_tests.py`

Покрытие (опционально):
```bash
pip install pytest-cov
pytest --cov=quotes --cov=config --cov-report=term-missing
```

Основные проверяемые сценарии:
- Случайная цитата: инкремент просмотров, отсутствие инкремента при `no_view=1`, корректная работа `exclude`
- Голосование: первый лайк/дизлайк, защита от повторного голоса, переключение лайк ↔ дизлайк
- Топ‑10: единая страница `/popular/` с сортировками `likes|views|dislikes`
- Добавление цитаты: создание новой записи и соблюдение лимита 3 цитаты на источник
- Модель: уникальность (регистронезависимо) по тексту+источнику и валидация лимита источника

